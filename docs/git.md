# Bash-Funk "git" module

[//]: # (THIS FILE IS GENERATED BY BASH-FUNK GENERATOR)

This module only loads if the git commandline client is installed.

The following commands are available when this module is loaded:

1. [-git-branch-name](#-git-branch-name)
1. [-git-cherry-pick](#-git-cherry-pick)
1. [-git-create-empty-branch](#-git-create-empty-branch)
1. [-git-fetch-pr](#-git-fetch-pr)
1. [-git-log](#-git-log)
1. [-git-modified-files](#-git-modified-files)
1. [-git-squash](#-git-squash)
1. [-git-switch-remote-protocol](#-git-switch-remote-protocol)
1. [-git-sync-fork](#-git-sync-fork)
1. [-git-update-branch](#-git-update-branch)
1. [-github-upstream-url](#-github-upstream-url)
1. [-test-git](#-test-git)


## <a name="license"></a>License

Copyright 2015-2018 by Vegard IT GmbH, Germany, https://vegardit.com
SPDX-License-Identifier: Apache-2.0

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.


## <a name="-git-branch-name"></a>-git-branch-name

```
Usage: -git-branch-name [OPTION]... [PATH]

Prints the name of the currently checked out git branch.

Parameters:
  PATH (default: '.', directory)
      The path to check.

Options:
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
    --
        Terminates the option list.
```

*Implementation:*
```bash
git -C "$_PATH" rev-parse --symbolic-full-name --abbrev-ref HEAD
```


## <a name="-git-cherry-pick"></a>-git-cherry-pick

```
Usage: -git-cherry-pick [OPTION]... COMMIT_HASHES1 [COMMIT_HASHES]...

Cherry picks a commit into the currently checked out branch.

Parameters:
  COMMIT_HASHES (1 or more required)
      Hashes of commits to cherry pick.

Options:
    --pr PR_NUMBER (integer: 1-?)
        First fetches the pull request with the given number to be able to cherry pick from that PR.
    --pull 
        Execute 'git pull' before cherry picking.
    --push 
        Execute 'git push --force' after cherry picking.
    -----------------------------
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
    --
        Terminates the option list.
```

*Implementation:*
```bash
if [[ $_pull ]]; then
    git pull || return 1
fi

if [[ $_pr ]]; then
    git fetch origin pull/${_pr}/head:pr-${_pr} || return 1
fi

git cherry-pick ${_COMMIT_HASHES[@]} || return 1

if [[ $_push ]]; then
    git push
fi
```


## <a name="-git-create-empty-branch"></a>-git-create-empty-branch

```
Usage: -git-create-empty-branch [OPTION]... BRANCH_NAME

Creates a new empty branch in the local repository.

Parameters:
  BRANCH_NAME (required)
      The name of the new branch.

Options:
    --push 
        Execute 'git push --set-upstream origin <BRANCH_NAME>' after branch creation.
    -----------------------------
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
    --
        Terminates the option list.
```

*Implementation:*
```bash
if git rev-parse --verify ${_BRANCH_NAME} &>/dev/null; then
    echo "-git-create-empty-branch: A branch named [${_BRANCH_NAME}] already exists."
    return 1
fi

git checkout --orphan ${_BRANCH_NAME} &&
git clean -fd &&
git rm -rf . &&
git commit -am "Created empty branch." --allow-empty || return 1

if [[ $_push ]]; then
    git push --set-upstream origin ${_BRANCH_NAME}
fi
```


## <a name="-git-fetch-pr"></a>-git-fetch-pr

```
Usage: -git-fetch-pr [OPTION]... PR_NUMBER

Fetches the given pull request.

Parameters:
  PR_NUMBER (required, integer: 1-?)
      The number of the pull request to fetch.

Options:
-c, --checkout 
        Checkout the PR branch after fetching.
    -----------------------------
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
    --
        Terminates the option list.
```

*Implementation:*
```bash

git fetch origin pull/${_PR_NUMBER}/head:pr-${_PR_NUMBER} || return 1

if [[ $_checkout ]]; then
    git checkout pr-${_PR_NUMBER}
fi
```


## <a name="-git-log"></a>-git-log

```
Usage: -git-log [OPTION]...

Displays the git log of the current project in a pretty and compact format.

Options:
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
    --
        Terminates the option list.
```

*Implementation:*
```bash
git log --pretty=format:"%C(bold black)%h%Creset %an %C(bold black)%ar%Creset %s" --graph
```


## <a name="-git-modified-files"></a>-git-modified-files

```
Usage: -git-modified-files [OPTION]... [PATH]

Prints the name of the all deleted, changed and newly created files in the current directory tree.

Parameters:
  PATH (default: '.', directory)
      The path to check.

Options:
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
    --
        Terminates the option list.
```

*Implementation:*
```bash
git -C "$_PATH" ls-files -o -m -d --exclude-standard
```


## <a name="-git-squash"></a>-git-squash

```
Usage: -git-squash [OPTION]... NUM_COMMITS

Squashes the last n commits into one.

Requirements:
  + Command 'awk' must be available.

Parameters:
  NUM_COMMITS (required, integer: 2-?)
      Number of commits to squash.

Options:
-m, --message COMMIT_MESSAGE 
        The commit message to be used instead of the original ones.
    --pull 
        Execute 'git pull' before squashing.
    --push 
        Execute 'git push --force' after squashing.
    -----------------------------
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
    --
        Terminates the option list.
```

*Implementation:*
```bash
if [[ $_pull ]]; then
    git pull || return 1
fi

if [[ $_message ]]; then
   local commitMsg="${_message}"
else
   # load the commit messages, remove duplicates and blank lines
   local commitMsg="$(git log -${_NUM_COMMITS} --pretty=%B | awk 'NF > 0 && !a[$0]++')"
fi

git reset --soft HEAD~${_NUM_COMMITS} || return 1
git commit --allow-empty-message -m "${commitMsg}" || return 1

if [[ $_push ]]; then
    git push --force
fi
```


## <a name="-git-switch-remote-protocol"></a>-git-switch-remote-protocol

```
Usage: -git-switch-remote-protocol [OPTION]... REMOTE_NAME1 [REMOTE_NAME]... PROTOCOL

Switches the protocol of the given remote(s) between HTTPS and SSH.

Parameters:
  REMOTE_NAME (1 or more required)
      The name of the remote, e.g. 'origin', 'upstream'. If not specified all remotes are changed.
  PROTOCOL (required, one of: [https,ssh])
      The new protocol to use.

Options:
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
    --
        Terminates the option list.
```

*Implementation:*
```bash
local url remote

for remote in "${_REMOTE_NAME[@]}"; do
    if url=$(git remote get-url $_REMOTE_NAME); then
        case "$_PROTOCOL" in
            ssh)
                case "$url" in
                    https://*)
                        echo "Switching protocol of remote [$remote] to SSH..."
                        git remote set-url origin "git@${url#https://*}"
                        git remote -v | grep "^$remote"
                      ;;
                    git@*)
                        echo "Remote [$remote] already uses SSH: $url"
                      ;;
                    *)
                        echo "-git-switch-remote-protocol: URL [$url] for remote [$remote] starts with unknown protocol."
                        return 1
                      ;;
                esac
              ;;

            https)
                case "$url" in
                    https://*)
                        echo "Remote [$remote] already uses HTTPS: $url"
                      ;;
                    git@*)
                        echo "Switching protocol of remote [$remote] to HTTPS..."
                        git remote set-url origin "https://${url#git@*}"
                        git remote -v | grep "^$remote"
                      ;;
                    *)
                        echo "-git-switch-remote-protocol: URL [$url] for remote [$remote] starts with unknown protocol."
                        return 1
                      ;;
                esac
              ;;
        esac
    else
        return 1
    fi
done
```


## <a name="-git-sync-fork"></a>-git-sync-fork

```
Usage: -git-sync-fork [OPTION]...

Syncs the currently checked out branch of a forked repository with it's upstream repository. Uses 'git rebase -p' instead of 'git merge' by default to prevent an extra commit for the merge operation.

Options:
    --branch NAME 
        Branch in the forked repository to sync.
    --merge 
        Use 'git merge' instead of 'git rebase -p'.
    --push 
        Push updates to origin after sync.
    --upstream_branch NAME 
        Branch in the upstream repository to sync with.
    -----------------------------
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
    --
        Terminates the option list.
```

*Implementation:*
```bash
local currBranch currBranch_remote currBranch_remoteURL upstreamURL

# e.g. 'master'
if [[ ${_branch:-} ]]; then
    currBranch=$_branch
else
    currBranch=$(git rev-parse --symbolic-full-name --abbrev-ref HEAD) || return 1
fi

# e.g. 'origin'
currBranch_remote=$(git config branch.$currBranch.remote) || return 1
currBranch_remoteURL=$(git config --get remote.$currBranch_remote.url) || return 1

upstreamURL=$(git remote get-url "upstream" 2>/dev/null) || true
if [[ ! $upstreamURL ]]; then
    # if forked repo is on github try to get the upstream URL via github API
    local githubRepo="${currBranch_remoteURL#*github.com/}"
    githubRepo="${githubRepo%.git}"
    if [[ ! $currBranch_remoteURL == *github.com/* ]] || ! upstreamURL="$(-github-upstream-url "${githubRepo}")"; then
        echo "-git-sync-fork: No remote 'upstream' defined. You can add it using 'git remote add upstream [REMOTE_URL]'."
        return 1
    fi
    echo "Adding remote 'upstream $upstreamURL'..."
    git remote add upstream $upstreamURL || return 1
fi

local _upstream_branch=${_upstream_branch:-$currBranch}

echo "Fetching updates from 'upstream/$_upstream_branch'..."
git fetch upstream $_upstream_branch || return 1

git checkout $_branch || return 1

echo "Incorporating updates from 'upstream/$_upstream_branch' into '$currBranch'..."
if [[ $_merge ]]; then
    git merge upstream/$_upstream_branch || return 1
else
    git rebase -p upstream/$_upstream_branch || return 1
fi

if [[ $_push ]]; then
    echo "Pushing updates to 'origin/$currBranch'..."
    git push --follow-tags --force origin $currBranch
fi
```


## <a name="-git-update-branch"></a>-git-update-branch

```
Usage: -git-update-branch [OPTION]... [BRANCH] MASTER

Updates the given branch using 'git rebase -p' by default.

Parameters:
  BRANCH 
      Name of the branch to update.
  MASTER (required)
      Name of the branch to get updates from.

Options:
    --merge 
        Use 'git merge' instead of 'git rebase -p'. Rule of thumb: use 'git rebase -p' for updating personal branches and 'git merge' for updating shared branches with commits by others.
    --push 
        Push updates to origin after sync.
    -----------------------------
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
    --
        Terminates the option list.
```

*Implementation:*
```bash
if [[ ! ${_BRANCH:-} ]]; then
    _BRANCH=$(git rev-parse --symbolic-full-name --abbrev-ref HEAD) || return 1
fi

git checkout $_MASTER &&
git pull &&
git checkout $_BRANCH || return 1

echo "Incorporating updates from '$_MASTER' into '$_BRANCH'..."
if [[ $_merge ]]; then
    git merge $_MASTER || return 1
else
    git rebase -p $_MASTER || return 1
fi

if [[ $_push ]]; then
    echo "Pushing updates to 'origin/$_BRANCH'..."
    git push --follow-tags --force origin $_BRANCH
fi
```


## <a name="-github-upstream-url"></a>-github-upstream-url

```
Usage: -github-upstream-url [OPTION]... REPO

Prints the upstream URL in case the given GitHub repository is a fork.

Parameters:
  REPO (required)
      The github repository to check, e.g. 'vegardit/bash-funk'.

Options:
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
    --
        Terminates the option list.
```

*Implementation:*
```bash
hash wget &>/dev/null && local get="wget -qO-" || local get="curl -fs"

$get https://api.github.com/repos/$_REPO | grep -A100 '"parent":' | grep clone_url | head -n1 | cut -d'"' -f4
return ${PIPESTATUS[0]}
```


## <a name="-test-git"></a>-test-git

```
Usage: -test-git [OPTION]...

Performs a selftest of all functions of this module by executing each function with option '--selftest'.

Options:
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
    --
        Terminates the option list.
```

*Implementation:*
```bash
-git-branch-name --selftest && echo || return 1
-git-cherry-pick --selftest && echo || return 1
-git-create-empty-branch --selftest && echo || return 1
-git-fetch-pr --selftest && echo || return 1
-git-log --selftest && echo || return 1
-git-modified-files --selftest && echo || return 1
-git-squash --selftest && echo || return 1
-git-switch-remote-protocol --selftest && echo || return 1
-git-sync-fork --selftest && echo || return 1
-git-update-branch --selftest && echo || return 1
-github-upstream-url --selftest && echo || return 1
```
