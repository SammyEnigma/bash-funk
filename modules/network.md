# Bash-Funk "network" module

[//]: # (THIS FILE IS GENERATED BY BASH-FUNK GENERATOR)

The following commands are available when this module is loaded:

1. [-block-port](#-block-port)
1. [-get-ips](#-get-ips)
1. [-is-port-open](#-is-port-open)
1. [-run-echo-server](#-run-echo-server)
1. [-ssh-agent-add-key](#-ssh-agent-add-key)
1. [-ssh-trust-host](#-ssh-trust-host)
1. [-test-network](#-test-network)


## <a name="license"></a>License

Copyright (c) 2015-2017 Vegard IT GmbH, http://vegardit.com

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.



## <a name="-block-port"></a>-block-port

```
Usage: -block-port [OPTION]... [BIND_ADDRESS] PORT

Binds to the given port and thus block other programs from binding to it.

Parameters:
  BIND_ADDRESS (default: '0.0.0.0')
      The local bind address. E.g. 127.0.0.1.
  PORT (required, integer: 0-65535)
      Number of the port to occupy.

Options:
-d, --duration SECONDS (integer: ?-?)
        Duration in seconds to block the port.
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.

Examples:
$ -block-port --duration 1  12345
Binding to 0.0.0.0:12345...
Press [CTRL]+[C] to abort.
$ -block-port -d 1  127.0.0.1  12345
Binding to 127.0.0.1:12345...
Press [CTRL]+[C] to abort.
```

*Implementation:*
```bash
echo "Binding to $_BIND_ADDRESS:$_PORT..."

[[ $_duration ]] && local timeout="Timeout => $_duration," || local timeout="";

perl << EOF
    use IO::Socket;
    \$server = IO::Socket::INET->new(
        LocalAddr => '$_BIND_ADDRESS',
        LocalPort => $_PORT,
        Type => SOCK_STREAM,
        ReuseAddr => 1,
        $timeout
        Listen => 10
    ) or die "Couldn't bind to $_BIND_ADDRESS:$_PORT: \$@\n";
    print("Press [CTRL]+[C] to abort.\n");
    while (\$client = \$server->accept()) { }
    close(\$server);
EOF
```


## <a name="-get-ips"></a>-get-ips

```
Usage: -get-ips [OPTION]...

Prints the IP v4 addresses of this host excluding 127.0.0.1.

Options:
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
```

*Implementation:*
```bash
ifconfig | grep -Eo 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -Eo '([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1'
```


## <a name="-is-port-open"></a>-is-port-open

```
Usage: -is-port-open [OPTION]... HOSTNAME PORT [CONNECT_TIMEOUT_IN_SECONDS]

Checks if a TCP connection can be established to the given port.

Parameters:
  HOSTNAME (required)
      Target hostname.
  PORT (required, integer: 0-65535)
      Target TCP port.
  CONNECT_TIMEOUT_IN_SECONDS (default: '5', integer: ?-?)
      Number of seconds to try to connect to the given port. Default is 5 seconds.

Options:
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
-v, --verbose 
        Prints additional information during command execution.

Examples:
$ -is-port-open localhost 12345 1

$ -is-port-open -v localhost 12345 1
localhost:12345 is not reachable.
```

*Implementation:*
```bash
if hash nc &>/dev/null; then
    if nc -vz -w $_CONNECT_TIMEOUT_IN_SECONDS $_HOSTNAME $_PORT; then
        portStatus=open
    else
        portStatus=
    fi
else
    local portStatus=$(perl << EOF
        use IO::Socket;
        my \$socket=IO::Socket::INET->new(
            PeerAddr => "$_HOSTNAME",
            PeerPort => $_PORT,
            Timeout => $_CONNECT_TIMEOUT_IN_SECONDS
        );

        if (defined \$socket) {
            sleep 1;
            (defined \$socket->connected ? print("open") : q{});
        }
EOF
    )
fi

if [[ $portStatus == "open" ]]; then
    [[ $_verbose ]] && echo "$_HOSTNAME:$_PORT is open." || true
    return 0
else
    [[ $_verbose ]] && echo "$_HOSTNAME:$_PORT is not reachable." || true
    return 1
fi
```


## <a name="-run-echo-server"></a>-run-echo-server

```
Usage: -run-echo-server [OPTION]... [BIND_ADDRESS] PORT

Runs a simple single-connection TCP echo server.

Requirements:
  + Command 'python' must be available.

Parameters:
  BIND_ADDRESS (default: '0.0.0.0')
      The local bind address. E.g. 127.0.0.1.
  PORT (required, integer: 0-65535)
      Number of the TCP port to be used.

Options:
    --disconnect_when string 
        String that can be send to the server to disconnect the current connection.
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
    --stop_when string 
        String that can be send to the server to shut it down.
```

*Implementation:*
```bash

if [[ ! $_stop_when ]]; then
    local _stop_when=stop
fi

if [[ ! $_disconnect_when ]]; then
    local _disconnect_when=quit
fi

python -c "
import socket, sys

def run():
    srv = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    srv.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    srv.bind(('$_BIND_ADDRESS', $_PORT))
    srv.listen(0)

    print_ = sys.stdout.write
    print_('Running TCP echo server on $_BIND_ADDRESS:$_PORT...\\n')

    while 1:
        conn, src_addr = srv.accept()
        print_('[CONNECT] ' + str(src_addr) + '\\n')

        while 1:
            data, src_addr = conn.recvfrom(256)

            if not data:
                continue

            if data == '$_stop_when\r\n':
                print_('[SHUTDOWN] ' + str(src_addr) + '\\n')
                sys.exit(0)

            if data == '$_disconnect_when\r\n':
                print_('[DISCONNECT] ' + str(src_addr) + '\\n')
                conn.shutdown(1)
                conn.close()
                break

            conn.sendall(data)
            print_(data)

try:
    run()
except KeyboardInterrupt:
    pass
"
```


## <a name="-ssh-agent-add-key"></a>-ssh-agent-add-key

```
Usage: -ssh-agent-add-key [OPTION]... KEY_FILE PASSWORD

Adds the private key to the ssh-agent.

Requirements:
  + Command 'ssh-add' must be available.
  + Command 'ssh-agent' must be available.
  + Command 'expect' must be available.

Parameters:
  KEY_FILE (required, file)
      Path to the key file.
  PASSWORD (required)
      Password to open the key file.

Options:
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
```

*Implementation:*
```bash
eval $(ssh-agent)

expect << EOF
  spawn ssh-add $_KEY_FILE
  expect "Enter passphrase"
  send "$_PASSWORD\r"
  expect eof
EOF
```


## <a name="-ssh-trust-host"></a>-ssh-trust-host

```
Usage: -ssh-trust-host [OPTION]... HOSTNAME [PORT]

Adds the public key of the given host to the ~/.ssh/known_hosts file.

Requirements:
  + Command 'ssh-keyscan' must be available.

Parameters:
  HOSTNAME (required)
      Remote SSH Hostname.
  PORT (default: '22', integer: 0-65535)
      Remote SSH port.

Options:
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
```

*Implementation:*
```bash
touch ~/.ssh/known_hosts
ssh-keyscan -t rsa,dsa -p $_PORT $_HOSTNAME 2>/dev/null | sort -u - ~/.ssh/known_hosts > ~/.ssh/known_hosts.tmp
mv ~/.ssh/known_hosts.tmp ~/.ssh/known_hosts
```


## <a name="-test-network"></a>-test-network

```
Usage: -test-network [OPTION]...

Performs a selftest of all functions of this module by executing each function with option '--selftest'.

Options:
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
```

*Implementation:*
```bash
-block-port --selftest && echo || return 1
-get-ips --selftest && echo || return 1
-is-port-open --selftest && echo || return 1
-run-echo-server --selftest && echo || return 1
-ssh-agent-add-key --selftest && echo || return 1
-ssh-trust-host --selftest && echo || return 1
```
