# Bash-Funk "misc" module

[//]: # (THIS FILE IS GENERATED BY BASH-FUNK GENERATOR)

The following statements are automatically executed when this module loads:

```bash
function -timeout() {
    if [[ $# < 2 || ${1:-} == "--help" ]]; then
        echo "Usage: ${FUNCNAME[0]} TIMEOUT COMMAND [ARG]..."
        echo "Executes the COMMAND and aborts if it does not finish within the given TIMEOUT in seconds."
        [[ ${1:-} == "--help" ]] && return 0 || return 1
    fi
    # see: http://mywiki.wooledge.org/BashFAQ/068
    perl -e 'alarm shift; exec @ARGV' "$@";
}
```

The following commands are available when this module is loaded:

1. [-help](#-help)
1. [-please](#-please)
1. [-reload](#-reload)
1. [-test-all](#-test-all)
1. [-test-misc](#-test-misc)
1. [-tweak-bash](#-tweak-bash)
1. [-update](#-update)
1. [-var-exists](#-var-exists)
1. [-wait](#-wait)


## <a name="license"></a>License

Copyright (c) 2015-2017 Vegard IT GmbH, http://vegardit.com

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.


## <a name="-help"></a>-help

```
Usage: -help [OPTION]...

Prints the online help of all bash-funk commands.

Options:
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
```

*Implementation:*
```bash
for helpfunc in $(compgen -A function -- -help-); do
    $helpfunc
done | sort
```


## <a name="-please"></a>-please

```
Usage: -please [OPTION]...

Re-runs the previously entered command with sudo.

Requirements:
  + Command 'sudo' must be available.

Options:
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
```

*Implementation:*
```bash
local cmd="$(echo $(fc -ln -1))"

if [[ $cmd == sudo* ]]; then
    echo "$__fn: Last command '$cmd' was already executed with sudo."
    exit 1
elif [[ $cmd == -please* ]]; then
    echo "$__fn: Executing last command '$cmd' with sudo has no use."
    exit 1
fi

[[ $__interactive ]] && echo -e "Executing last command [\033[35m$cmd\033[0m] with sudo..." || true
sudo "$BASH" -c "$cmd"
```


## <a name="-reload"></a>-reload

```
Usage: -reload [OPTION]...

Reloads bash-funk.

Options:
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
```

*Implementation:*
```bash
if [[ ! ${__BASH_FUNK_ROOT} ]]; then
    echo "$__fn: Error: __BASH_FUNK_ROOT variable is not defined."
    return 1
fi

if [[ ! -r ${__BASH_FUNK_ROOT}/bash-funk.sh ]]; then
    echo "$__fn: Error: File [${__BASH_FUNK_ROOT}/bash-funk.sh] is not readable by user [$USER]."
    return 1
fi

source ${__BASH_FUNK_ROOT}/bash-funk.sh
```


## <a name="-test-all"></a>-test-all

```
Usage: -test-all [OPTION]...

Executes the selftests of all loaded bash-funk commands.

Options:
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
```

*Implementation:*
```bash
for testfunc in $(compgen -A function -- -test-); do
    if [[ $testfunc != "-test-all" ]]; then
        $testfunc || return 1
    fi
done
```


## <a name="-test-misc"></a>-test-misc

```
Usage: -test-misc [OPTION]...

Performs a selftest of all functions of this module by executing each function with option '--selftest'.

Options:
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
```

*Implementation:*
```bash
-help --selftest && echo || return 1
-please --selftest && echo || return 1
-reload --selftest && echo || return 1
-test-all --selftest && echo || return 1
-tweak-bash --selftest && echo || return 1
-update --selftest && echo || return 1
-var-exists --selftest && echo || return 1
-wait --selftest && echo || return 1
```


## <a name="-tweak-bash"></a>-tweak-bash

```
Usage: -tweak-bash [OPTION]...

Performs some usability configurations of Bash.

Options:
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
-v, --verbose 
        Prints additional information during command execution.
```

*Implementation:*
```bash

# enable and configure command history
set -o history
export HISTFILE=~/.bash_funk_history
export HISTSIZE=10000
export HISTFILESIZE=$HISTSIZE
export HISTCONTROL=ignorespace:ignoredups
export HISTTIMEFORMAT="%F %T "
export HISTIGNORE="&:?:??:clear:exit:pwd"
history -r

alias -- grep="command grep --colour=auto"
alias -- gh='command history | grep'
alias -- l="ll"
alias -- ll="-ll"
alias -- ++="-cd-down"
alias -- --="-cd-hist"
alias -- ..="-cd-up"
alias -- ...="command cd ../.."

# http://wiki.bash-hackers.org/internals/shell_options
local opt opts=(autocd checkwinsize dirspell direxpand extglob globstar histappend)
for opt in ${opts[@]}; do
    if shopt -s $opt &>/dev/null; then
        [[ $_verbose ]] && echo "shopt -s $opt => ENABLED"
    else
        [[ $_verbose ]] && echo "shopt -s $opt => UNSUPPORTED"
    fi
done

# cygwin tweaks                
if [[ $OSTYPE == "cygwin" ]]; then
    for drive in {a..z}; do
        if [[ -e /cygdrive/${drive} ]]; then
            alias -- "${drive}:"="cd /cygdrive/${drive}"
            alias -- "${drive^^}:"="cd /cygdrive/${drive}"
        fi
    done
    
    if !hash sudo >/dev/null; then
        alias -- sudo="cygstart --action=runas"
    fi
fi
```


## <a name="-update"></a>-update

```
Usage: -update [OPTION]...

Updates bash-funk with the latest code from the github repo.

Options:
    --help 
        Prints this help.
-r, --reload 
        Reloads the bash-funk after updating.
    --selftest 
        Performs a self-test.
-y, --yes 
        Answer interactive prompts with 'yes'.
```

*Implementation:*
```bash
if [[ ! ${__BASH_FUNK_ROOT} ]]; then
    echo "$__fn: Error: __BASH_FUNK_ROOT variable is not defined."
    return 1
fi

if [[ ! -w ${__BASH_FUNK_ROOT} ]]; then
    echo "$__fn: Error: Directory [${__BASH_FUNK_ROOT}] is not writeable by user [$USER]."
    return 1
fi

if [[ ! $_yes ]]; then
    read -p "Are you sure you want to update bash-funk located in [${__BASH_FUNK_ROOT}]? (y) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "$__fn: Aborting on user request."
        return 0
    fi
fi

# update via SVN
if [[ -e "${__BASH_FUNK_ROOT}/.svn" ]]; then
    svn update "${__BASH_FUNK_ROOT}" || return
    [[ $_reload ]] && ${__BASH_FUNK_PREFIX:--}reload || true
    return
fi

# update via Git
if [[ -e "${__BASH_FUNK_ROOT}/.git" ]]; then
    ( cd "${__BASH_FUNK_ROOT}" && git fetch && git merge ) || return
    [[ $_reload ]] && ${__BASH_FUNK_PREFIX:--}reload || true
    return
fi

# update via curl/wget
local get
if hash curl &>/dev/null; then
    get="curl -#L"
else
    if wget --help | grep -- --show-progress &>/dev/null; then
        get="wget -qO- --show-progress"
    else
        get="wget -qO-"
    fi
fi
( cd "${__BASH_FUNK_ROOT}" && $get https://github.com/vegardit/bash-funk/tarball/master | tar -xzv --strip-components 1 ) || return
[[ $_reload ]] && ${__BASH_FUNK_PREFIX:--}reload || true
return
```


## <a name="-var-exists"></a>-var-exists

```
Usage: -var-exists [OPTION]... VARIABLE_NAME

Determines if the given variable is declared.

Parameters:
  VARIABLE_NAME (required)
      Name of the Bash variable to check.

Options:
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
-v, --verbose 
        Prints additional information during command execution.

Examples:
$ -var-exists USER

$ -var-exists -v USER
Bash variable 'USER' exists.
$ -var-exists -v NON_EXISTANT_VARIABLE
Bash variable 'NON_EXISTANT_VARIABLE' does not exist.
```

*Implementation:*
```bash
if declare -p $_VARIABLE_NAME &>/dev/null; then
    [[ $_verbose ]] && echo "Bash variable '$_VARIABLE_NAME' exists." || true
    return 0
else
    [[ $_verbose ]] && echo "Bash variable '$_VARIABLE_NAME' does not exist." || true
    return 1
fi
```


## <a name="-wait"></a>-wait

```
Usage: -wait [OPTION]... SECONDS

Waits for the given number of seconds or until the key 's' pressed.

Parameters:
  SECONDS (required)
      Number of seconds to wait.

Options:
    --help 
        Prints this help.
    --selftest 
        Performs a self-test.
```

*Implementation:*
```bash
local green="\033[1;32m"
local reset="\033[0m"
local saveCursor="\033[s"
local restoreCursor="\033[u"
local cursor9Right="\033[9C"
local cursor9Left="\033[9D"

echo -ne "Waiting for [$(date +%T --date=@$(($_SECONDS - 3600)))] until $(date +%T --date=@$(($(date +%s) + $_SECONDS))). Press [s] to skip: $cursor9Right"
for (( i = 0; i < _SECONDS; i++ )); do
    if [[ $__interactive ]]; then
        local newLine=
    else
        # adding a \n new line character to the end of the line to make the output parseable by sed which is line oriented
        local newLine="$saveCursor\n$restoreCursor"
    fi
    echo -ne "$cursor9Left$green$(date +%T --date=@$(($_SECONDS - ${i} - 3600))) $reset$newLine"
    local char=
    read -s -n1 -t1 char || :
    [[ $char == "s" ]] && break
done
echo
```
